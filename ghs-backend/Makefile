# Makefile pour GHS Backend NestJS

.PHONY: help install dev build start test clean docker-up docker-down init-db lint format

# Variables
APP_NAME=ghs-backend
DOCKER_COMPOSE=docker-compose
NPM=npm

# Couleurs pour les messages
RED=\033[0;31m
GREEN=\033[0;32m
YELLOW=\033[1;33m
NC=\033[0m # No Color

## help: Afficher l'aide
help:
	@echo "$(GREEN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(GREEN)               GHS Backend NestJS - Commandes Disponibles                      $(NC)"
	@echo "$(GREEN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo ""
	@echo "$(YELLOW)Installation & Configuration:$(NC)"
	@echo "  make install          - Installer toutes les dÃ©pendances"
	@echo "  make setup            - Configuration initiale complÃ¨te"
	@echo "  make init-db          - Initialiser la base de donnÃ©es avec donnÃ©es de test"
	@echo ""
	@echo "$(YELLOW)DÃ©veloppement:$(NC)"
	@echo "  make dev              - DÃ©marrer en mode dÃ©veloppement (watch)"
	@echo "  make start            - DÃ©marrer normalement"
	@echo "  make debug            - DÃ©marrer en mode debug"
	@echo "  make build            - Compiler le projet"
	@echo ""
	@echo "$(YELLOW)Tests:$(NC)"
	@echo "  make test             - ExÃ©cuter les tests unitaires"
	@echo "  make test-watch       - Tests en mode watch"
	@echo "  make test-cov         - Tests avec coverage"
	@echo "  make test-e2e         - Tests end-to-end"
	@echo ""
	@echo "$(YELLOW)QualitÃ© du code:$(NC)"
	@echo "  make lint             - Linter le code"
	@echo "  make format           - Formatter le code"
	@echo "  make check            - VÃ©rifier le code (lint + format)"
	@echo ""
	@echo "$(YELLOW)Docker:$(NC)"
	@echo "  make docker-up        - DÃ©marrer avec Docker Compose"
	@echo "  make docker-down      - ArrÃªter Docker Compose"
	@echo "  make docker-build     - Construire l'image Docker"
	@echo "  make docker-logs      - Voir les logs Docker"
	@echo "  make docker-clean     - Nettoyer Docker (volumes, images)"
	@echo ""
	@echo "$(YELLOW)Base de donnÃ©es:$(NC)"
	@echo "  make db-create        - CrÃ©er la base de donnÃ©es"
	@echo "  make db-migrate       - ExÃ©cuter les migrations"
	@echo "  make db-seed          - Remplir avec donnÃ©es de test"
	@echo "  make db-reset         - RÃ©initialiser la base de donnÃ©es"
	@echo ""
	@echo "$(YELLOW)Utilitaires:$(NC)"
	@echo "  make clean            - Nettoyer les fichiers gÃ©nÃ©rÃ©s"
	@echo "  make clean-all        - Nettoyage complet (node_modules, dist, etc.)"
	@echo "  make logs             - Voir les logs de l'application"
	@echo "  make health           - VÃ©rifier l'Ã©tat de l'API"
	@echo ""
	@echo "$(GREEN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"

## install: Installer les dÃ©pendances
install:
	@echo "$(GREEN)ğŸ“¦ Installation des dÃ©pendances...$(NC)"
	$(NPM) install
	@echo "$(GREEN)âœ… DÃ©pendances installÃ©es!$(NC)"

## setup: Configuration initiale complÃ¨te
setup: install
	@echo "$(GREEN)ğŸ”§ Configuration initiale...$(NC)"
	@if [ ! -f .env ]; then \
		echo "$(YELLOW)âš ï¸  Fichier .env non trouvÃ©. Copie de .env.example...$(NC)"; \
		cp .env.example .env; \
		echo "$(YELLOW)âš ï¸  Pensez Ã  Ã©diter le fichier .env avec vos paramÃ¨tres!$(NC)"; \
	else \
		echo "$(GREEN)âœ… Fichier .env dÃ©jÃ  prÃ©sent$(NC)"; \
	fi
	@echo "$(GREEN)âœ… Configuration terminÃ©e!$(NC)"

## dev: DÃ©marrer en mode dÃ©veloppement
dev:
	@echo "$(GREEN)ğŸš€ DÃ©marrage en mode dÃ©veloppement...$(NC)"
	$(NPM) run start:dev

## start: DÃ©marrer l'application
start:
	@echo "$(GREEN)ğŸš€ DÃ©marrage de l'application...$(NC)"
	$(NPM) run start

## debug: DÃ©marrer en mode debug
debug:
	@echo "$(GREEN)ğŸ› DÃ©marrage en mode debug...$(NC)"
	$(NPM) run start:debug

## build: Compiler le projet
build:
	@echo "$(GREEN)ğŸ”¨ Compilation du projet...$(NC)"
	$(NPM) run build
	@echo "$(GREEN)âœ… Compilation terminÃ©e!$(NC)"

## test: ExÃ©cuter les tests unitaires
test:
	@echo "$(GREEN)ğŸ§ª ExÃ©cution des tests unitaires...$(NC)"
	$(NPM) run test

## test-watch: Tests en mode watch
test-watch:
	@echo "$(GREEN)ğŸ§ª Tests en mode watch...$(NC)"
	$(NPM) run test:watch

## test-cov: Tests avec coverage
test-cov:
	@echo "$(GREEN)ğŸ§ª Tests avec coverage...$(NC)"
	$(NPM) run test:cov

## test-e2e: Tests end-to-end
test-e2e:
	@echo "$(GREEN)ğŸ§ª ExÃ©cution des tests e2e...$(NC)"
	$(NPM) run test:e2e

## lint: Linter le code
lint:
	@echo "$(GREEN)ğŸ” Analyse du code...$(NC)"
	$(NPM) run lint

## format: Formatter le code
format:
	@echo "$(GREEN)âœ¨ Formatage du code...$(NC)"
	$(NPM) run format

## check: VÃ©rifier le code
check: lint
	@echo "$(GREEN)âœ… VÃ©rification du code terminÃ©e!$(NC)"

## docker-up: DÃ©marrer avec Docker Compose
docker-up:
	@echo "$(GREEN)ğŸ³ DÃ©marrage avec Docker Compose...$(NC)"
	$(DOCKER_COMPOSE) up -d
	@echo "$(GREEN)âœ… Services dÃ©marrÃ©s!$(NC)"
	@echo "$(YELLOW)ğŸ“š Documentation: http://localhost:8000/docs$(NC)"
	@echo "$(YELLOW)â¤ï¸  Health check: http://localhost:8000/health$(NC)"

## docker-down: ArrÃªter Docker Compose
docker-down:
	@echo "$(GREEN)ğŸ³ ArrÃªt de Docker Compose...$(NC)"
	$(DOCKER_COMPOSE) down
	@echo "$(GREEN)âœ… Services arrÃªtÃ©s!$(NC)"

## docker-build: Construire l'image Docker
docker-build:
	@echo "$(GREEN)ğŸ³ Construction de l'image Docker...$(NC)"
	$(DOCKER_COMPOSE) build
	@echo "$(GREEN)âœ… Image construite!$(NC)"

## docker-logs: Voir les logs Docker
docker-logs:
	@echo "$(GREEN)ğŸ³ Logs Docker...$(NC)"
	$(DOCKER_COMPOSE) logs -f

## docker-clean: Nettoyer Docker
docker-clean:
	@echo "$(RED)ğŸ§¹ Nettoyage Docker...$(NC)"
	$(DOCKER_COMPOSE) down -v
	docker system prune -f
	@echo "$(GREEN)âœ… Nettoyage Docker terminÃ©!$(NC)"

## init-db: Initialiser la base de donnÃ©es
init-db:
	@echo "$(GREEN)ğŸ—„ï¸  Initialisation de la base de donnÃ©es...$(NC)"
	$(NPM) run build
	node dist/scripts/init-db.js
	@echo "$(GREEN)âœ… Base de donnÃ©es initialisÃ©e!$(NC)"

## db-create: CrÃ©er la base de donnÃ©es
db-create:
	@echo "$(GREEN)ğŸ—„ï¸  CrÃ©ation de la base de donnÃ©es...$(NC)"
	@. ./.env && mysql -h$$DB_HOST -u$$DB_USER -p$$DB_PASSWORD -e "CREATE DATABASE IF NOT EXISTS $$DB_NAME;"
	@echo "$(GREEN)âœ… Base de donnÃ©es crÃ©Ã©e!$(NC)"

## db-migrate: ExÃ©cuter les migrations
db-migrate:
	@echo "$(GREEN)ğŸ—„ï¸  ExÃ©cution des migrations...$(NC)"
	$(NPM) run typeorm migration:run
	@echo "$(GREEN)âœ… Migrations exÃ©cutÃ©es!$(NC)"

## db-seed: Remplir avec donnÃ©es de test
db-seed: init-db
	@echo "$(GREEN)âœ… DonnÃ©es de test insÃ©rÃ©es!$(NC)"

## db-reset: RÃ©initialiser la base de donnÃ©es
db-reset:
	@echo "$(RED)âš ï¸  RÃ©initialisation de la base de donnÃ©es...$(NC)"
	@. ./.env && mysql -h$$DB_HOST -u$$DB_USER -p$$DB_PASSWORD -e "DROP DATABASE IF EXISTS $$DB_NAME; CREATE DATABASE $$DB_NAME;"
	@. ./.env && mysql -h$$DB_HOST -u$$DB_USER -p$$DB_PASSWORD $$DB_NAME < ../ghs.sql
	@echo "$(GREEN)âœ… Base de donnÃ©es rÃ©initialisÃ©e!$(NC)"
	@make db-seed

## clean: Nettoyer les fichiers gÃ©nÃ©rÃ©s
clean:
	@echo "$(GREEN)ğŸ§¹ Nettoyage des fichiers gÃ©nÃ©rÃ©s...$(NC)"
	rm -rf dist
	rm -rf coverage
	rm -rf .nyc_output
	@echo "$(GREEN)âœ… Nettoyage terminÃ©!$(NC)"

## clean-all: Nettoyage complet
clean-all: clean
	@echo "$(RED)ğŸ§¹ Nettoyage complet...$(NC)"
	rm -rf node_modules
	rm -rf package-lock.json
	@echo "$(GREEN)âœ… Nettoyage complet terminÃ©!$(NC)"

## logs: Voir les logs de l'application
logs:
	@echo "$(GREEN)ğŸ“‹ Logs de l'application...$(NC)"
	tail -f logs/*.log

## health: VÃ©rifier l'Ã©tat de l'API
health:
	@echo "$(GREEN)â¤ï¸  VÃ©rification de l'Ã©tat de l'API...$(NC)"
	@curl -s http://localhost:8000/health | jq '.' || echo "$(RED)âŒ API non disponible$(NC)"

## prod-build: Compiler pour la production
prod-build:
	@echo "$(GREEN)ğŸš€ Compilation pour la production...$(NC)"
	NODE_ENV=production $(NPM) run build
	@echo "$(GREEN)âœ… Build de production terminÃ©!$(NC)"

## prod-start: DÃ©marrer en production
prod-start:
	@echo "$(GREEN)ğŸš€ DÃ©marrage en mode production...$(NC)"
	NODE_ENV=production $(NPM) run start:prod

## status: Afficher l'Ã©tat des services
status:
	@echo "$(GREEN)ğŸ“Š Ã‰tat des services:$(NC)"
	@echo ""
	@echo "$(YELLOW)Docker Compose:$(NC)"
	@$(DOCKER_COMPOSE) ps || echo "$(RED)Docker Compose non actif$(NC)"
	@echo ""
	@echo "$(YELLOW)API Health:$(NC)"
	@make health

## update: Mettre Ã  jour les dÃ©pendances
update:
	@echo "$(GREEN)ğŸ”„ Mise Ã  jour des dÃ©pendances...$(NC)"
	$(NPM) update
	@echo "$(GREEN)âœ… DÃ©pendances mises Ã  jour!$(NC)"

## generate: GÃ©nÃ©rer un module (usage: make generate MODULE=nom)
generate:
	@if [ -z "$(MODULE)" ]; then \
		echo "$(RED)âŒ Erreur: MODULE non spÃ©cifiÃ©$(NC)"; \
		echo "$(YELLOW)Usage: make generate MODULE=nom$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)ğŸ—ï¸  GÃ©nÃ©ration du module $(MODULE)...$(NC)"
	nest generate module $(MODULE)
	nest generate controller $(MODULE)
	nest generate service $(MODULE)
	@echo "$(GREEN)âœ… Module $(MODULE) gÃ©nÃ©rÃ©!$(NC)"

## docs: Ouvrir la documentation
docs:
	@echo "$(GREEN)ğŸ“š Ouverture de la documentation...$(NC)"
	@open http://localhost:8000/docs || xdg-open http://localhost:8000/docs || start http://localhost:8000/docs

## shell: Ouvrir un shell dans le container
shell:
	@echo "$(GREEN)ğŸš Ouverture d'un shell...$(NC)"
	$(DOCKER_COMPOSE) exec backend sh

## db-shell: Ouvrir un shell MySQL
db-shell:
	@echo "$(GREEN)ğŸ—„ï¸  Ouverture d'un shell MySQL...$(NC)"
	$(DOCKER_COMPOSE) exec mysql mysql -uroot -p$$DB_PASSWORD $$DB_NAME